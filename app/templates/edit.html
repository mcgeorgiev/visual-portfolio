{% extends "base.html" %}
{% block content %}
  <link rel="stylesheet" href="static/stylesheets/tiles.css" type="text/css">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <link rel="stylesheet" href="static/stylesheets/edit-popups.css" type="text/css">
  <link rel="stylesheet" href="static/stylesheets/dev-bar.css" type="text/css">



  {% include 'dev-bar.html'%}

<div id="edit-info">
  <button id="set-images" type="button">Confirm Images</button>
  <span id="result"></span>
</div>
<div id="outside-container">
  <div id="edit-container">
    {% include "nav.html" %}

    <div class="thumbnail-grid-edit">
      <div id="sortable" class="grid">
        {% for image in data.images %}
        <div class="cell" id={{ image.id }}>
          <img src="{{ image.thumbnail_path }}" class="responsive-image">
          <div class="top-left">
            <img src="static/assets/pencil-button.png" class="icon edit-button" height="24" width="24">
            <img src="static/assets/delete.png" class="icon delete" height="24" width="24">
          </div>
          <!-- <div class ="overlay"><div class="text">{{ image.title }}</div></div> -->
        </div>
        {% endfor %}
      </div>
    </div>


    <div id="editPopup" class="modal">

      <!-- Popup content -->
      <div class="modal-content">
        <span class="close">&times;</span>
        <div id="left">
          <img id="edit-thumbnail" src="#">
        </div>
        <div id="right">
          <form action="#" id="edit-form">
              <label>Title</label>:
              <input id="edit-title" type="text" name="title" value="" ><br>
              <label>Description:</label><br>
              <textarea id="edit-description" name="description" ></textarea><br>
              <input id="edit-id" type="hidden" name="id" value="">
          </form>
          <div id="edit-popup-buttons">
            <div>
              <div id="message"></div>
            </div>
            <div>
              <button id="preview">Preview</button>
              <!-- <button>Change Thumbnail Selection</button> -->
              <button id="accept">Accept</button>
            </div>
          </div>
        </div>
      </div>

    </div>

    <div id="" class="deletePopup modal">
      <div class="modal-content delete-content">
        <span class="close">&times;</span>
        <label id="delete-label">Are you sure?</label>
        <div id="delete-buttons">
          <button id="delete-cancel">No</button>
          <button id="delete-confirm">Yes</button>
        </div>
        <div id="delete-message">
          <button id="ok-button">OK</button>
        </div>
      </div>
    </div>
  </div>
  {% include "footer.html" %}
</div>
  <script>
  $( document ).ready(function(){

    $("#sortable").sortable({
      placeholder: {
          element: function(currentItem) {
              return $("<div class='cell placeholder'></div>")[0];
          },
          update: function(container, p) {
              return;
          },
      }
    });
    $("#sortable").disableSelection();
    $("#sortable").sortable({ items : '.cell:not(.unsortable)' });


    var imageNum = $(".cell").length;
    var rowLength = 3;
    var remainder = imageNum % rowLength;

    if (remainder === 0) {
      // if remainder is 0: add a single add cell.
      $(".grid").append("<div class='cell unsortable'></div>");
    }

    if (remainder !== 0) {
      var emptyCellNum = rowLength - remainder;
      for (var i = 0; i < emptyCellNum; i++) {
        $(".grid").append("<div class='cell unsortable'></div>");
      }
    }

    //add an add button to imageNum + 1
    var addPosition = imageNum + 1;
    var addElement = $('.grid .cell:nth-child(' + addPosition + ')');
    addElement.prepend('<img class="add-button" src="static/assets/add.png" />')
    addElement.addClass("add-cell");

    $('#set-images').click(function() {

      // get the ids and positions in an object
      var positionObject = {};
      $( ".cell" ).each(function(index) {
        // console.log(index + ": " + $(this).attr("id"));
        positionObject[index] = $(this).attr("id");
      });

      // ajax it
      $.ajax({
        url:"/set_positions",
        type: "post",
        dataType: "json",
        data: {postitionData: JSON.stringify(positionObject)},
        success: function(result) {
          console.log(result.response);
          $("#result").text(result.response)
        }
      });
    });

    $('.close').click(function() {
      $("#editPopup").css("display", "none");
      $(".deletePopup").css("display", "none");
      resetDeletePopup();
    });

    $("#ok-button").click(function() {
        $(".deletePopup").css("display", "none");
        resetDeletePopup();
    });


    function getEditInfo(e, handleData) {
      var cellElement = $(e.target).parent().parent();
      var imageID = cellElement.attr('id');
      // ajax it
      var imageData;
      $.ajax({
        url: "/get_edit_info",
        type: "get",
        data: {id: imageID},
        success: function(result) {
          handleData(result)
        }
      });
      return imageData;
    }

    $(window).click(function(e) {
      if ($(e.target).hasClass('edit-button')) {
        $("#editPopup").css("display", "block");
        var imageData = getEditInfo(e, function(result) {
          console.log(result);
          $('#edit-title').val(result.title);
          $('#edit-description').text(result.description);
          $('#edit-thumbnail').attr("src", result.thumbnail);
          $("#edit-id").val(result.id);

          $('#edit-title').focus();
        });

      } else if ($("#editPopup").css("display") == "block") {
        if ($(e.target).parents("#editPopup").length === 0) {
          $("#editPopup").css("display", "none");
          $("#edit-id").val("");
        }
      }
    });

    $("#accept").click(function() {
      var newMeta = {};
      newMeta.id = $("#edit-id").val();
      newMeta.title = $('#edit-title').val();
      newMeta.description = $('#edit-description').text();
      $.ajax({
        url:"/change_meta_data",
        type: "post",
        dataType: "json",
        data: {imageMeta: JSON.stringify(newMeta)},
        success: function(result) {
          // console.log(result.response);
          $("#message").text(result.response)
        }
      });
    });

    $(window).click(function(e) {
      if ($(e.target).hasClass("delete")) {
        var cellElement = $(e.target).parent().parent();
        var imageID = cellElement.attr('id');
        console.log(imageID);
        $(".deletePopup").css("display", "block");
        $(".deletePopup").attr("id", imageID);

      } else if ($(".deletePopup").css("display") == "block") {
        if ($(e.target).parents(".deletePopup").length === 0) {
          $(".deletePopup").css("display", "none");
          resetDeletePopup();
        }
      }
    });

    function resetDeletePopup() {
      $("#delete-buttons").css("display", "block");
      $("#delete-message").css("display", "none");
      $("#delete-label").text("Are you sure?");
      location.reload();
    }

    function getPositions() {
      var positionObject = {};
      $( ".cell" ).each(function(index) {
        // console.log(index + ": " + $(this).attr("id"));
        positionObject[index] = $(this).attr("id");
      });
      return positionObject;
    }

    $("#delete-confirm").click(function() {
      var imageID = $(".deletePopup").attr("id");
      var positionObject = getPositions();
      $.ajax({
        url:"/delete_image",
        type: "post",
        dataType: "json",
        data: {
          id: imageID,
          positions: JSON.stringify(positionObject)
        },
        success: function(result) {
          console.log(result.response);
          $("#delete-buttons").css("display", "none");
          $("#delete-message").css("display", "block");
          $("#delete-label").text(result.response);
        }
      });
    });

    $(".add-cell").click(function() {
      alert("add new image");
    });


  });



  </script>

{% endblock %}
